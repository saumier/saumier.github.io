<html>
  <head>
    <!-- Load c3.css -->
    <link href="c3.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">

  </head>
  <body>
    <section class="section">
      <div class="container">
        <h1 class="title"> RMP Chart - Personal </h1>
        <div id="msg"></div>
        <div id="chart"> </div>
      </div>

    <!-- Load d3.js and c3.js -->
    <script src="d3.min.js" charset="utf-8"></script>
    <script src="c3.min.js"></script>

    <script>
      let rmpData = [];
      let rmpDates = [];
      const data_url = "https://culture-huginn.herokuapp.com/users/1/web_requests/27/rmp.json";
      const trigger_update_url =  "https://culture-huginn.herokuapp.com/users/1/web_requests/50/callrbc"
      const msg_display = document.getElementById('msg')
      let refresh_trigger_called = false;


      function setup_timeout(msg) {
        console.log("msg ",msg);
        msg_display.textContent = msg;
        msg_display.classList.add("notification")
        msg_display.classList.add("is-warning")
        // callback get_chart_data in 10 sec
        setTimeout(function () {
                get_chart_data();
                msg_display.textContent = ""
                msg_display.classList.remove("notification")
                msg_display.classList.remove("is-warning")
              }, 1000*10);
      }

      function refresh_data() {
        //check if a fetch is already in progress. If so then don't do another.
        if (refresh_trigger_called) {
          setup_timeout("Waiting for update...")
        } else {
          fetch(trigger_update_url)
            .then((resp) => resp.json())
            .then(function(data) {
              setup_timeout("Triggering an update...")
            })
            .catch(function(error) {
              console.log("Error", error);
          });
          refresh_trigger_called = true;
        }
      }

      function render_chart()  {
        var chart = c3.generate({
          bindto: '#chart',
          data:
            {
              x: 'x',
              columns: [rmpDates,rmpData]
            },
          axis:
            {x: { type: 'timeseries', tick: {
                  format: '%Y-%m-%d %Hh',
                  count: 6
            }}}
          });
      }

      function get_chart_data() {
        console.log("calling server", data_url);
        fetch(data_url)
          .then((resp) => resp.json())
          .then(function(data) {
            rmpData.push(data.title);
            rmpDates.push('x');
            data.items.forEach(function(item) {
              if (item.content != "") {
                rmpData.push(Number(item.content));
                rmpDates.push(Date.parse(item.pubDate));
              }
            });
            console.log("data",rmpData, rmpDates);
            render_chart()
            let current_date = new Date()
            let freshLimit = current_date.getTime() - (24 * 60 * 60 * 1000);
            console.log("freshLimit: " + new Date(freshLimit));

            if (rmpDates[1] < freshLimit) {
              console.log("Calling update trigger since last data is from " + new Date(rmpDates[1]));
              refresh_data();  //refresh if date is older than a day
            };

          })
          .catch(function(error) {
              console.log("Error", error);
          });
      }

      get_chart_data()

    </script>
  </body>
</html>
